<div class="tooltip-wrapper" id="tooltip-wrapper">
  <div id="tooltip-content"></div>
</div>

<script>
(function() {
  var opacityTimeout, contentTimeout;
  var transitionDurationMs = 100;
  var tooltipWrapper = document.getElementById('tooltip-wrapper');
  var tooltipContent = document.getElementById('tooltip-content');
  var cache = {};

  function hideTooltip() {
    opacityTimeout = setTimeout(function() {
      tooltipWrapper.style.opacity = 0;
      contentTimeout = setTimeout(function() {
        tooltipContent.innerHTML = '';
        tooltipWrapper.style.display = 'none';
      }, transitionDurationMs + 1);
    }, transitionDurationMs);
  }

  function showTooltip(event) {
    var elem = event.target;
    var rects = elem.getClientRects();
    var elemProps = rects[rects.length - 1];
    var scrollTop = window.pageYOffset || document.documentElement.scrollTop;

    if (elem.host !== window.location.host) return;

    function renderTooltip(html) {
      tooltipContent.innerHTML = html;
      tooltipWrapper.style.display = 'block';
      setTimeout(function() { tooltipWrapper.style.opacity = 1; }, 1);

      tooltipWrapper.style.left = (elemProps.left - (tooltipWrapper.offsetWidth / 2) + (elemProps.width / 2)) + 'px';
      if ((window.innerHeight - elemProps.top) < tooltipWrapper.offsetHeight) {
        tooltipWrapper.style.top = (elemProps.top + scrollTop - tooltipWrapper.offsetHeight - 10) + 'px';
      } else {
        tooltipWrapper.style.top = (elemProps.top + scrollTop + 35) + 'px';
      }
      if ((elemProps.left + elemProps.width / 2) < (tooltipWrapper.offsetWidth / 2)) {
        tooltipWrapper.style.left = '10px';
      } else if ((document.body.clientWidth - elemProps.left - elemProps.width / 2) < (tooltipWrapper.offsetWidth / 2)) {
        tooltipWrapper.style.left = (document.body.clientWidth - tooltipWrapper.offsetWidth - 20) + 'px';
      }
    }

    if (cache[elem.href]) {
      renderTooltip(cache[elem.href]);
      return;
    }

    fetch(elem.href)
      .then(function(r) { return r.text(); })
      .then(function(html) {
        var parser = new DOMParser();
        var doc = parser.parseFromString(html, 'text/html');
        var h1 = doc.querySelector('h1');
        var content = doc.querySelector('.note-content');
        if (!h1 || !content) return;
        var preview = '<div class="tooltip-title">' + h1.textContent + '</div>' + content.innerHTML;
        cache[elem.href] = preview;
        renderTooltip(preview);
      })
      .catch(function() {});
  }

  function setupListeners(link) {
    link.addEventListener('mouseleave', hideTooltip);
    link.addEventListener('touchend', hideTooltip);
    link.addEventListener('mouseenter', function(e) {
      clearTimeout(opacityTimeout);
      clearTimeout(contentTimeout);
      showTooltip(e);
    });
  }

  tooltipWrapper.addEventListener('mouseleave', hideTooltip);
  tooltipWrapper.addEventListener('touchend', hideTooltip);
  tooltipWrapper.addEventListener('mouseenter', function() {
    clearTimeout(opacityTimeout);
    clearTimeout(contentTimeout);
  });

  document.querySelectorAll('{{ include.wrapperQuerySelector }} a').forEach(function(link) {
    // Skip same-page anchor links (e.g. TOC links)
    if (link.getAttribute('href') && link.getAttribute('href').charAt(0) === '#') return;
    // Skip links inside the TOC
    if (link.closest('.toc')) return;
    setupListeners(link);
  });
})();
</script>
